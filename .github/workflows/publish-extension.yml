name: Publish VSCode Extension

on:
  push:
    tags:
      - 'ext-v*.*.*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
    
    - name: Install dependencies
      working-directory: ./extension
      run: npm install
    
    - name: Compile extension
      working-directory: ./extension
      run: npm run compile
    
    - name: Package extension
      working-directory: ./extension
      run: |
        npm install -g @vscode/vsce
        vsce package
    
    - name: Publish to VSCode Marketplace
      if: startsWith(github.ref, 'refs/tags/ext-v')
      working-directory: ./extension
      run: vsce publish -p ${{ secrets.VSCE_PAT }}
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
    
    - name: Upload VSIX as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sheplang-vscode-extension
        path: extension/*.vsix
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/ext-v')
      uses: softprops/action-gh-release@v1
      with:
        files: extension/*.vsix
        body: |
          ## ShepLang VSCode Extension Release
          
          Install the extension from the [VSCode Marketplace](https://marketplace.visualstudio.com/items?itemName=golden-sheep-ai.sheplang-vscode)
          
          Or download the `.vsix` file and install manually:
          ```bash
          code --install-extension sheplang-vscode-*.vsix
          ```
          
          ### Features
          - ✅ Syntax highlighting for `.shep` and `.shepthon`
          - ✅ Live preview
          - ✅ Language server with IntelliSense
          - ✅ Verification engine integration
          - ✅ 5 project templates
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
