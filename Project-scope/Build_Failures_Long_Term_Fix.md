# üîß ShepLang/ShepKit Build Failures - Long-Term Solution

**Based on Official Documentation:**
- [Vercel Package Managers](https://vercel.com/docs/package-managers)
- [Vercel Corepack Support](https://vercel.com/changelog/improved-support-for-pnpm-corepack-and-monorepos)
- [pnpm Continuous Integration](https://pnpm.io/continuous-integration)
- [pnpm Installation](https://pnpm.io/installation)

---

## üìä Root Cause Analysis

### Issue 1: pnpm Version Inconsistency ‚ö†Ô∏è

**Problem:**
```
Detected pnpm-lock.yaml 9 which may be generated by pnpm@9.x or pnpm@10.x
Using pnpm@10.x based on project creation date
```

**Why it fails:**
- lockfileVersion: '9.0' is compatible with both pnpm 9 and pnpm 10
- Vercel auto-selects pnpm 10 for newer projects
- Local development uses pnpm 10.21.0
- But subtle differences in pnpm 9 vs 10 can cause build inconsistencies

**Official Vercel docs state:**
> "pnpm-lock.yaml version 9.0 can be generated by pnpm 9 or 10. Newer projects will prefer 10, while older prefer 9."

### Issue 2: Langium Generator + TypeScript Timing ‚ö†Ô∏è

**Problem:**
```
packages/language build: Writing generated files to /vercel/path0/sheplang/packages/language/src/generated
packages/language build: src/index.ts(3,31): error TS2307: Cannot find module '../generated/ast'
```

**Why it fails:**
- Langium generates files successfully
- TypeScript compiler runs immediately after
- Generated files exist but TypeScript can't resolve them
- Likely caused by:
  1. Module resolution mode (`"moduleResolution": "Bundler"`)
  2. File system sync issues in CI
  3. Missing `.js` extensions in imports

### Issue 3: npm vs pnpm in Build Script ‚ö†Ô∏è

**Problem:**
```json
// In packages/language/package.json
"build": "npm run generate && tsc -p tsconfig.build.json"
```

**Why it's problematic:**
- Uses `npm run` in a pnpm monorepo
- Creates inconsistency between local and CI
- pnpm has different script execution behavior

---

## ‚úÖ Long-Term Solution (7 Steps)

### Step 1: Pin Exact pnpm Version with Corepack

**File:** `package.json` (root)

**Add:**
```json
{
  "name": "sheplang-root",
  "private": true,
  "type": "module",
  "packageManager": "pnpm@10.21.0",
  "scripts": { ... }
}
```

**Official Source:**
- [Vercel Corepack Documentation](https://vercel.com/changelog/improved-support-for-pnpm-corepack-and-monorepos)
- [pnpm Installation with Corepack](https://pnpm.io/installation#using-corepack)

**Why this works:**
1. Corepack is built into Node.js 20.x
2. Vercel automatically detects `packageManager` field
3. Ensures exact same version locally and on Vercel
4. Applies to all packages in monorepo

**Verification:**
```bash
# Local
corepack enable
corepack prepare pnpm@10.21.0 --activate
pnpm --version # Should show 10.21.0

# Vercel (automatic)
# Reads packageManager field from root package.json
```

---

### Step 2: Fix Language Package Build Script

**File:** `sheplang/packages/language/package.json`

**Current:**
```json
"scripts": {
  "generate": "langium generate",
  "build": "npm run generate && tsc -p tsconfig.build.json"
}
```

**Fix to:**
```json
"scripts": {
  "generate": "langium generate",
  "build": "pnpm run generate && tsc -p tsconfig.build.json",
  "prebuild": "pnpm run generate"
}
```

**Why this works:**
1. Uses `pnpm run` instead of `npm run` for consistency
2. Adds `prebuild` hook to ensure generation happens first
3. pnpm automatically runs `prebuild` before `build`
4. Prevents timing issues between generation and compilation

**Alternative (cleaner):**
```json
"scripts": {
  "generate": "langium generate",
  "build": "tsc -p tsconfig.build.json",
  "prebuild": "langium generate"
}
```

---

### Step 3: Fix TypeScript Module Resolution

**File:** `sheplang/packages/language/tsconfig.json`

**Current:**
```json
{
  "compilerOptions": {
    "moduleResolution": "Bundler"
  }
}
```

**Fix to:**
```json
{
  "compilerOptions": {
    "moduleResolution": "Node",
    "allowImportingTsExtensions": false
  }
}
```

**Why this works:**
- `"Node"` resolution is more predictable in CI environments
- `"Bundler"` is optimized for bundlers like Vite/esbuild
- Generated files from Langium use standard Node resolution
- Prevents "Cannot find module" errors after generation

**Official Source:**
- [TypeScript Module Resolution](https://www.typescriptlang.org/docs/handbook/module-resolution.html)

---

### Step 4: Update Import Paths in Language Package

**Files to check:**
- `sheplang/packages/language/src/index.ts`
- `sheplang/packages/language/src/mapper.ts`
- `sheplang/packages/language/src/shep-module.ts`

**Ensure imports use `.js` extensions:**

**Current:**
```typescript
import { ... } from '../generated/ast';
import { ... } from '../generated/module';
```

**Fix to:**
```typescript
import { ... } from '../generated/ast.js';
import { ... } from '../generated/module.js';
```

**Why this works:**
- TypeScript with ESM requires `.js` extensions
- `"type": "module"` in package.json enforces this
- Matches the actual output files after compilation
- Standard for modern ESM packages

**Official Source:**
- [TypeScript ESM Support](https://www.typescriptlang.org/docs/handbook/esm-node.html)

---

### Step 5: Optimize Vercel Build Command

**File:** `sheplang/shepkit/vercel.json`

**Current:**
```json
{
  "buildCommand": "pnpm install --frozen-lockfile && pnpm -w -r build && pnpm build"
}
```

**Optimize to:**
```json
{
  "buildCommand": "pnpm -r --filter '@sheplang/language' run build && pnpm -r --filter '!@sheplang/e2e' run build && pnpm build",
  "installCommand": "pnpm install --frozen-lockfile"
}
```

**Why this works:**
1. **Explicit build order:** Language package builds first
2. **Filter optimization:** Skips e2e tests package
3. **Parallel builds:** pnpm runs other packages in parallel
4. **Separated install:** Install happens once before build

**Better alternative (using workspace dependencies):**
```json
{
  "buildCommand": "pnpm -r --filter '@sheplang/shepkit^...' run build && pnpm build"
}
```

**This builds:**
1. All dependencies of ShepKit (language, runtime, adapters, etc.)
2. Then ShepKit itself
3. Automatically handles dependency order

**Official Source:**
- [pnpm Filtering](https://pnpm.io/filtering)

---

### Step 6: Add Build Verification to CI

**File:** `.github/workflows/vercel-deploy.yml`

**Add new job after `build-shepkit`:**

```yaml
  verify-langium-generation:
    name: Verify Langium Generation
    runs-on: ubuntu-latest
    needs: verify-build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare pnpm@10.21.0 --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Langium files
        working-directory: sheplang/packages/language
        run: pnpm run generate

      - name: Verify generated files exist
        run: |
          if [ ! -f "sheplang/packages/language/src/generated/ast.ts" ]; then
            echo "‚ùå Langium ast.ts not generated"
            exit 1
          fi
          if [ ! -f "sheplang/packages/language/src/generated/module.ts" ]; then
            echo "‚ùå Langium module.ts not generated"
            exit 1
          fi
          echo "‚úÖ Langium files generated successfully"

      - name: Build language package
        working-directory: sheplang/packages/language
        run: pnpm run build

      - name: Verify build artifacts
        run: |
          if [ ! -d "sheplang/packages/language/dist" ]; then
            echo "‚ùå Language package not built"
            exit 1
          fi
          echo "‚úÖ Language package built successfully"
```

**Why this helps:**
- Catches Langium generation issues early
- Verifies file existence before TypeScript compilation
- Runs in same environment as Vercel (Ubuntu + Node 20)
- Provides clear error messages

---

### Step 7: Update Documentation

**Create:** `Project-scope/Build_Troubleshooting.md`

**Include:**
1. Common build errors and fixes
2. How to test builds locally with exact Vercel environment
3. Debugging Langium generation issues
4. pnpm version management guide
5. Steps to reproduce Vercel builds locally

**Create:** `scripts/test-vercel-build.sh`

```bash
#!/bin/bash
# Test Vercel build locally

echo "üîß Testing Vercel build locally..."

# Enable corepack
corepack enable
corepack prepare pnpm@10.21.0 --activate

# Clean
rm -rf node_modules sheplang/*/node_modules
rm -rf sheplang/packages/*/dist
rm -rf sheplang/shepkit/.next

# Install
pnpm install --frozen-lockfile

# Build (same as Vercel)
pnpm -r --filter '@sheplang/shepkit^...' run build && pnpm --filter '@sheplang/shepkit' run build

echo "‚úÖ Build completed successfully"
```

---

## üéØ Implementation Checklist

### Phase 1: Critical Fixes (Do First)
- [ ] Add `"packageManager": "pnpm@10.21.0"` to root package.json
- [ ] Fix language package build script (use `pnpm run` instead of `npm run`)
- [ ] Add `prebuild` hook to language package
- [ ] Update import paths to use `.js` extensions
- [ ] Test locally: `pnpm install && pnpm -r build`

### Phase 2: Optimization
- [ ] Change TypeScript moduleResolution to "Node"
- [ ] Optimize Vercel buildCommand with filters
- [ ] Add Langium verification job to CI
- [ ] Create test-vercel-build.sh script

### Phase 3: Documentation
- [ ] Create Build_Troubleshooting.md
- [ ] Update Vercel_Deployment_Guide.md with Langium notes
- [ ] Document pnpm version management
- [ ] Add common errors section

---

## üß™ Testing Strategy

### Local Testing
```bash
# Clean everything
pnpm -r run clean
rm -rf node_modules sheplang/*/node_modules

# Enable corepack
corepack enable
corepack prepare pnpm@10.21.0 --activate

# Verify version
pnpm --version # Should show 10.21.0

# Fresh install
pnpm install --frozen-lockfile

# Build in order
pnpm -r --filter '@sheplang/language' run build
pnpm -r --filter '!@sheplang/e2e' run build
pnpm --filter '@sheplang/shepkit' run build
```

### CI Testing
1. Push to feature branch
2. GitHub Actions runs all verification jobs
3. Check build logs for Langium generation
4. Verify no TypeScript errors
5. Check ShepKit build artifacts exist

### Vercel Testing
1. Deploy preview build
2. Check build logs:
   - pnpm version used
   - Langium generation output
   - TypeScript compilation output
3. Verify deployment success
4. Test ShepKit IDE functionality

---

## üìä Success Metrics

### Build should succeed when:
- ‚úÖ pnpm version matches across local/CI/Vercel (10.21.0)
- ‚úÖ Langium generates files before TypeScript compiles
- ‚úÖ All workspace packages build in correct order
- ‚úÖ No "Cannot find module" errors
- ‚úÖ ShepKit .next directory created
- ‚úÖ Deployment completes without errors

### Build time targets:
- **Local:** < 2 minutes (cached)
- **CI:** < 5 minutes (GitHub Actions)
- **Vercel:** < 5 minutes (first build), < 2 minutes (cached)

---

## üîó Official Resources

1. **Vercel:**
   - [Package Managers](https://vercel.com/docs/package-managers)
   - [Corepack Support](https://vercel.com/changelog/improved-support-for-pnpm-corepack-and-monorepos)
   - [Monorepos](https://vercel.com/docs/monorepos)

2. **pnpm:**
   - [Continuous Integration](https://pnpm.io/continuous-integration)
   - [Filtering](https://pnpm.io/filtering)
   - [Workspaces](https://pnpm.io/workspaces)

3. **TypeScript:**
   - [Module Resolution](https://www.typescriptlang.org/docs/handbook/module-resolution.html)
   - [ESM Support](https://www.typescriptlang.org/docs/handbook/esm-node.html)

4. **Langium:**
   - [CLI Documentation](https://langium.org/docs/learn/workflow/generate_everything/)
   - [Integration Guide](https://langium.org/docs/recipes/buildsystem/)

---

## üö® Common Pitfalls to Avoid

### ‚ùå Don't:
1. Mix npm and pnpm in build scripts
2. Use different pnpm versions locally vs CI
3. Rely on implicit build order
4. Use "Bundler" moduleResolution in library packages
5. Skip the `.js` extension in ESM imports
6. Delete `pnpm-lock.yaml` to "fix" issues

### ‚úÖ Do:
1. Pin exact pnpm version with packageManager field
2. Use prebuild hooks for code generation
3. Explicitly filter and order builds
4. Use "Node" moduleResolution for libraries
5. Always include `.js` extensions in imports
6. Keep lockfile in version control

---

## üéâ Expected Outcome

After implementing this long-term solution:

1. **Builds are deterministic:**
   - Same pnpm version everywhere
   - Same build order every time
   - No random failures

2. **Builds are fast:**
   - Parallel builds where possible
   - Proper caching
   - Optimal filtering

3. **Builds are reliable:**
   - CI catches issues before Vercel
   - Clear error messages
   - Easy to debug

4. **Maintenance is simple:**
   - Well-documented process
   - Clear troubleshooting guide
   - Automated verification

---

**Last Updated:** 2025-01-13
**Maintained By:** ShepLang Team
**Status:** Long-Term Solution Plan
