#!/usr/bin/env node

// A simple test script to verify that our transpiler is working correctly

import path from 'path';
import fs from 'fs/promises';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const ROOT = path.join(__dirname, '..');

// Sample app model based on the todo.shep example
const todoApp = {
  name: "MyTodos",
  datas: [
    {
      name: "Todo",
      fields: [
        { name: "title", type: "text" },
        { name: "done", type: "yes/no" }
      ],
      rules: ["user can update own items"]
    }
  ],
  views: [
    {
      name: "Dashboard",
      list: "Todo",
      buttons: [
        { label: "Add Task", action: "CreateTodo" }
      ]
    }
  ],
  actions: [
    {
      name: "CreateTodo",
      params: [{ name: "title" }],
      ops: [
        { 
          kind: "add", 
          data: "Todo", 
          fields: { title: "title", done: false }
        },
        {
          kind: "show",
          view: "Dashboard"
        }
      ]
    }
  ]
};

async function runTest() {
  console.log("üöÄ Testing Transpiler...");
  
  try {
    // Import the transpiler dynamically
    const transpilerPath = path.join(ROOT, 'sheplang', 'packages', 'transpiler', 'src', 'index.ts');
    
    // Check if the file exists
    try {
      await fs.access(transpilerPath);
      console.log(`‚úÖ Found transpiler at ${transpilerPath}`);
    } catch (e) {
      console.error(`‚ùå Transpiler not found at ${transpilerPath}`);
      process.exit(1);
    }
    
    console.log("üì¶ Using sample app model:", todoApp.name);
    
    // We'd ideally import and use the transpiler directly, but for a test script
    // we'll use our AppModel and just verify the directory structure
    
    const outDir = path.join(ROOT, '.shep', 'out', todoApp.name);
    await fs.mkdir(outDir, { recursive: true });
    
    const mockOutput = `/* Auto-generated by @sheplang/transpiler */

// This is a mock output to verify directory structure
export const __appName = "${todoApp.name}";
export const __version = "1.0.0";
`;
    
    const entryPath = path.join(outDir, 'entry.ts');
    await fs.writeFile(entryPath, mockOutput, 'utf8');
    
    console.log(`‚úÖ Created mock output at ${entryPath}`);
    console.log("‚úÖ Directory structure verified.");
    
    // In a real scenario, we would do:
    // const { transpileToTS } = await import(transpilerPath);
    // const result = await transpileToTS(todoApp, { generateSnapshots: true });
    // console.log(`Generated: ${result.entryPath}`);
    
  } catch (error) {
    console.error("‚ùå Test failed:", error);
    process.exit(1);
  }
}

runTest();
